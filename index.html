<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام الجرد - شركة القرعاوي</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@zxing/browser@0.2.7/esm/index.min.js" rel="modulepreload">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Cairo', sans-serif;
    }

    body {
      margin: 0;
      background-color: #f4f4f4;
    }

    header {
      background-color: #00796b;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      position: relative;
    }

    header::after {
      content: "تصميم: أحمد صلاح";
      position: absolute;
      bottom: 5px;
      right: 10px;
      font-size: 0.7rem;
      opacity: 0.7;
    }

    .container {
      display: grid;
      grid-template-columns: 250px 1fr;
      min-height: calc(100vh - 60px);
    }

    nav {
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: fixed;
      width: 250px;
      height: 100%;
      overflow-y: auto;
      padding: 1rem 0;
    }

    nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    nav ul li {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      color: #333;
      transition: all 0.3s ease;
    }

    nav ul li:hover {
      background-color: #00796b;
      color: white;
    }

    nav ul li span {
      margin-right: 10px;
    }

    .main {
      padding: 2rem;
      margin-right: 250px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
    }

    .card {
      background-color: white;
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #00796b;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .card span {
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    .barcode-section {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: block;
    }

    .barcode-input {
      width: 100%;
      padding: 1rem;
      border: 2px solid #00796b;
      border-radius: 8px;
      font-size: 1.2rem;
      margin-bottom: 1rem;
      text-align: center;
      direction: ltr;
    }

    .barcode-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(0,121,107,0.2);
    }

    .scanner-container {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      position: relative;
      overflow: hidden;
      border-radius: 8px;
    }

    #qr-reader {
      width: 100% !important;
      border: none !important;
    }

    .scan-button {
      background: #00796b;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 1rem 0;
      width: 100%;
      display: block;
    }

    .scan-button:hover {
      background: #00695c;
      transform: translateY(-2px);
    }

    .guide-box {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: 200px;
      border: 3px solid #00796b;
      border-radius: 8px;
      pointer-events: none;
      z-index: 1000;
    }

    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }

      nav {
        width: 100%;
        height: auto;
        position: relative;
      }

      .main {
        margin-right: 0;
        padding: 1rem;
      }

      .grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }

      .barcode-input {
        font-size: 1rem;
        padding: 0.8rem;
      }

      .scan-button {
        font-size: 1rem;
        padding: 0.8rem 1.5rem;
      }
    }
  </style>
</head>
<body>
  <header>
    نظام الجرد - شركة القرعاوي
  </header>
  <div class="container">
    <nav>
      <ul>
        <li><span>🏠</span>الصفحة الرئيسية</li>
        <li><span>🛒</span>الأصناف</li>
        <li><span>📄</span>الفواتير</li>
        <li><span>💰</span>المصروفات</li>
        <li><span>📊</span>التقارير</li>
        <li><span>🧑‍💼</span>الموردين</li>
        <li><span>👥</span>العملاء</li>
        <li><span>🏬</span>المخازن</li>
        <li><span>⚙️</span>الإعدادات</li>
        <li><span>📦</span>الاشتراكات</li>
        <li><span>🔐</span>سياسة الخصوصية</li>
      </ul>
    </nav>
    <main class="main">
      <div class="barcode-section">
        <h2>قارئ الباركود</h2>
        <input type="text" class="barcode-input" id="barcodeInput" placeholder="أدخل رقم الباركود يدوياً..." autocomplete="off">
        <button class="scan-button" id="scanButton">
          <span>📷</span> مسح الباركود
        </button>
        <div class="scanner-container" id="scannerContainer" style="display: none;">
          <div id="qr-reader"></div>
          <div class="guide-box"></div>
        </div>
      </div>
      <div class="grid">
        <div class="card"><span>📄</span>الفواتير</div>
        <div class="card"><span>🛒</span>الأصناف</div>
        <div class="card"><span>💰</span>المصروفات</div>
        <div class="card"><span>📊</span>التقارير</div>
        <div class="card"><span>📥</span>الوارد</div>
        <div class="card"><span>📤</span>الصادر</div>
        <div class="card"><span>🧑‍💼</span>الموردين</div>
        <div class="card"><span>👥</span>العملاء</div>
        <div class="card"><span>🏬</span>المخازن</div>
        <div class="card"><span>⚙️</span>الإعدادات</div>
      </div>
    </main>
  </div>

  <script type="module">
    import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@0.2.7/esm/index.min.js';

    let codeReader = new BrowserMultiFormatReader();
    let selectedDeviceId;
    const scanButton = document.getElementById('scanButton');
    const scannerContainer = document.getElementById('scannerContainer');
    const barcodeInput = document.getElementById('barcodeInput');

    // Focus barcode input on page load
    window.addEventListener('DOMContentLoaded', () => {
      barcodeInput.focus();
    });

    // Clean barcode input
    barcodeInput.addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/[^\w\d]/g, '');
    });

    // Handle Enter key
    barcodeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && e.target.value.length >= 5) {
        handleBarcode(e.target.value);
      } else if (e.key === 'Enter') {
        Swal.fire({
          icon: 'warning',
          title: 'تنبيه',
          text: 'يجب أن يكون الباركود 5 أرقام على الأقل',
          confirmButtonText: 'حسناً'
        });
      }
    });

    async function startScanner() {
      try {
        const devices = await BrowserMultiFormatReader.listVideoInputDevices();
        selectedDeviceId = devices.find(d => d.label.toLowerCase().includes('back'))?.deviceId || devices[0]?.deviceId;

        if (!selectedDeviceId) {
          throw new Error('لم يتم العثور على كاميرا');
        }

        scannerContainer.style.display = 'block';
        scanButton.textContent = '🛑 إيقاف المسح';

        await codeReader.decodeFromVideoDevice(selectedDeviceId, 'qr-reader', (result, err) => {
          if (result) {
            handleBarcode(result.getText());
          }
        });
      } catch (err) {
        Swal.fire({
          icon: 'error',
          title: 'خطأ',
          text: 'فشل في تشغيل الكاميرا: ' + err.message,
          confirmButtonText: 'حسناً'
        });
        stopScanner();
      }
    }

    function stopScanner() {
      codeReader.reset();
      scannerContainer.style.display = 'none';
      scanButton.textContent = '📷 مسح الباركود';
    }

    scanButton.addEventListener('click', () => {
      if (scannerContainer.style.display === 'none') {
        startScanner();
      } else {
        stopScanner();
      }
    });

    function handleBarcode(barcode) {
      Swal.fire({
        icon: 'success',
        title: 'تم المسح بنجاح',
        text: 'الباركود: ' + barcode,
        confirmButtonText: 'حسناً'
      });
      barcodeInput.value = barcode;
      stopScanner();
      barcodeInput.focus();
    }

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      stopScanner();
    });
  </script>
</body>
</html>